# NFE Web Crawler Logging and Monitoring

This document describes the comprehensive logging and monitoring system for the NFE Web Crawler with AI Extraction.

## Overview

The logging system provides structured logging for all operations with support for:

- **Performance Metrics**: Response time, success rate, operation breakdown
- **AI Token Usage**: Input/output tokens, cached tokens, estimated costs
- **Cache Statistics**: Hit/miss rates, cache operations
- **Validation Metrics**: Success rate, common validation errors
- **Error Tracking**: Detailed error information with context

## Architecture

### Logger Service

The `LoggerService` is a singleton that tracks all operations across the NFE crawler services:

```typescript
import { loggerService } from '@/lib/services/nfe-crawler';

// Log messages
loggerService.info('service-name', 'operation', 'Message', { metadata });
loggerService.error('service-name', 'operation', 'Error message', { error });

// Track performance
const startTime = loggerService.startPerformanceTracking('operation-name');
// ... perform operation ...
loggerService.endPerformanceTracking(startTime, success, error);

// Log AI token usage
loggerService.logAITokenUsage(model, inputTokens, outputTokens, cachedTokens);

// Log cache operations
loggerService.logCacheOperation('hit', cacheKey);

// Log validation results
loggerService.logValidation(invoiceKey, isValid, errors);
```

## Integrated Services

### Web Crawler Service

Logs:

- Invoice key extraction attempts
- HTML fetch operations
- Retry attempts with delays
- Network errors and timeouts

### AI Parser Service

Logs:

- AI parsing operations
- Token usage and costs
- Cache hit/miss for prompt caching
- Response validation

### Validator Service

Logs:

- Validation operations
- Validation failures with detailed error messages
- Field-level validation errors

### Cache Manager

Logs:

- Cache hits and misses
- Cache set operations
- Cache clear operations

## Statistics API

Access comprehensive statistics via the API endpoint:

```bash
GET /api/invoices/stats
```

### Response Format

```json
{
  "success": true,
  "data": {
    "performance": {
      "totalOperations": 150,
      "successfulOperations": 145,
      "failedOperations": 5,
      "successRate": "96.67%",
      "averageResponseTime": "2345ms",
      "minResponseTime": "1200ms",
      "maxResponseTime": "5600ms",
      "operationBreakdown": [
        {
          "operation": "parse-invoice-from-url",
          "count": 100,
          "avgTime": "2500ms",
          "successRate": "98.00%"
        }
      ]
    },
    "aiTokens": {
      "totalRequests": 100,
      "totalInputTokens": "250,000",
      "totalOutputTokens": "50,000",
      "totalCachedTokens": "200,000",
      "totalTokens": "300,000",
      "totalCost": "$1.2500",
      "totalCacheSavings": "$0.5400",
      "averageTokensPerRequest": "3000",
      "averageCostPerRequest": "$0.0125"
    },
    "cache": {
      "totalOperations": 250,
      "hits": 150,
      "misses": 50,
      "sets": 50,
      "clears": 0,
      "hitRate": "75.00%"
    },
    "validation": {
      "totalValidations": 100,
      "successfulValidations": 95,
      "failedValidations": 5,
      "successRate": "95.00%",
      "commonErrors": [
        { "error": "Merchant CNPJ is invalid", "count": 3 },
        { "error": "Total amount does not match sum of item prices", "count": 2 }
      ]
    }
  }
}
```

## Performance Metrics

### Tracked Operations

1. **extract-invoice-key**: Time to extract invoice key from URL
2. **fetch-invoice-html**: Time to fetch HTML from government portal
3. **ai-parse-html**: Time for AI to parse HTML into structured data
4. **validate-invoice**: Time to validate parsed data
5. **parse-invoice-from-url**: Total time for complete parsing flow

### Metrics Collected

- **Total Operations**: Count of all operations
- **Success Rate**: Percentage of successful operations
- **Average Response Time**: Mean time across all operations
- **Min/Max Response Time**: Fastest and slowest operations
- **Operation Breakdown**: Per-operation statistics

## AI Token Usage

### Tracked Metrics

- **Input Tokens**: Tokens sent to AI (prompt + HTML)
- **Output Tokens**: Tokens generated by AI (JSON response)
- **Cached Tokens**: Tokens served from prompt cache (90% cost savings)
- **Total Cost**: Estimated cost based on model pricing
- **Cache Savings**: Money saved through prompt caching

### Cost Calculation

The logger uses current Anthropic pricing (as of November 2024):

| Model             | Input   | Output  | Cached Input |
| ----------------- | ------- | ------- | ------------ |
| Claude 3.5 Sonnet | $3/M    | $15/M   | $0.30/M      |
| Claude 3 Opus     | $15/M   | $75/M   | $1.50/M      |
| Claude 3 Haiku    | $0.25/M | $1.25/M | $0.025/M     |

## Cache Statistics

### Tracked Operations

- **Hits**: Successful cache retrievals
- **Misses**: Cache lookups that failed (not found or expired)
- **Sets**: New entries added to cache
- **Clears**: Entries removed from cache

### Hit Rate Calculation

```
Hit Rate = Hits / (Hits + Misses)
```

A high hit rate (>70%) indicates effective caching and cost savings.

## Validation Metrics

### Tracked Data

- **Total Validations**: Count of all validation attempts
- **Success Rate**: Percentage of validations that passed
- **Common Errors**: Most frequent validation failures

### Common Validation Errors

The system tracks and reports the most common validation errors to help identify:

- Data quality issues
- AI parsing problems
- Portal format changes

## Log Levels

### DEBUG

Detailed information for debugging, typically disabled in production.

### INFO

General informational messages about normal operations.

### WARN

Warning messages for potentially problematic situations.

### ERROR

Error messages for failures and exceptions.

## Log Format

All logs use structured JSON format:

```json
{
  "timestamp": "2025-11-06T10:30:45.123Z",
  "level": "info",
  "service": "web-crawler",
  "operation": "extract-invoice-key",
  "message": "Invoice key extracted successfully",
  "metadata": {
    "url": "https://sat.sef.sc.gov.br/nfce/consulta",
    "invoiceKey": "42251109477652004850651140001754231806228292"
  }
}
```

## Security Considerations

### Sensitive Data Sanitization

The logger automatically sanitizes sensitive information:

- **API Keys**: Replaced with `[REDACTED]`
- **Tokens**: Replaced with `[REDACTED]`
- **Passwords**: Replaced with `[REDACTED]`
- **URLs**: Query parameters removed, only origin + pathname kept

### Example

```typescript
// Input
{
  url: 'https://api.example.com/data?apiKey=secret123&token=xyz';
}

// Logged
{
  url: 'https://api.example.com/data';
}
```

## Usage Examples

### Basic Logging

```typescript
import { loggerService } from '@/lib/services/nfe-crawler';

// Info message
loggerService.info('my-service', 'my-operation', 'Operation completed', {
  result: 'success',
  count: 42,
});

// Error message
loggerService.error('my-service', 'my-operation', 'Operation failed', {
  error: error.message,
  stack: error.stack,
});
```

### Performance Tracking

```typescript
import { loggerService } from '@/lib/services/nfe-crawler';

async function myOperation() {
  const startTime = loggerService.startPerformanceTracking('my-operation');

  try {
    // Perform operation
    await doSomething();

    loggerService.endPerformanceTracking(startTime, true);
  } catch (error) {
    loggerService.endPerformanceTracking(startTime, false, error.message);
    throw error;
  }
}
```

### Getting Statistics

```typescript
import { loggerService } from '@/lib/services/nfe-crawler';

// Get all statistics
const stats = loggerService.getStats();

// Get specific statistics
const perfStats = loggerService.getPerformanceStats();
const aiStats = loggerService.getAITokenStats();
const cacheStats = loggerService.getCacheStats();
const validationStats = loggerService.getValidationStats();
```

### Clearing Metrics

```typescript
import { loggerService } from '@/lib/services/nfe-crawler';

// Clear all metrics (useful for testing or periodic resets)
loggerService.clearMetrics();
```

## Monitoring Best Practices

1. **Monitor Success Rate**: Alert if success rate drops below 95%
2. **Track Response Time**: Alert if average response time exceeds 5 seconds
3. **Watch Cache Hit Rate**: Alert if hit rate drops below 70%
4. **Monitor AI Costs**: Track daily/monthly spending on AI tokens
5. **Review Validation Errors**: Investigate common validation failures

## Integration with External Services

The logging system can be easily integrated with external monitoring services:

### Datadog

```typescript
import { loggerService } from '@/lib/services/nfe-crawler';
import { datadogLogs } from '@datadog/browser-logs';

// Forward logs to Datadog
const originalLog = loggerService.log.bind(loggerService);
loggerService.log = (level, service, operation, message, metadata) => {
  originalLog(level, service, operation, message, metadata);
  datadogLogs.logger.log(message, { level, service, operation, ...metadata });
};
```

### Sentry

```typescript
import { loggerService } from '@/lib/services/nfe-crawler';
import * as Sentry from '@sentry/nextjs';

// Forward errors to Sentry
const originalError = loggerService.error.bind(loggerService);
loggerService.error = (service, operation, message, metadata) => {
  originalError(service, operation, message, metadata);
  Sentry.captureMessage(message, {
    level: 'error',
    tags: { service, operation },
    extra: metadata,
  });
};
```

## Environment Configuration

Control logging behavior via environment variables:

```bash
# Disable logging in test environment
NODE_ENV=test

# Enable debug logging
LOG_LEVEL=debug
```

## Troubleshooting

### High Response Times

Check the operation breakdown to identify slow operations:

```typescript
const stats = loggerService.getPerformanceStats();
console.log(stats.operationBreakdown);
```

### Low Cache Hit Rate

Review cache operations to understand why cache is not being used:

```typescript
const cacheStats = loggerService.getCacheStats();
console.log(`Hit rate: ${cacheStats.hitRate * 100}%`);
```

### High AI Costs

Monitor token usage to identify opportunities for optimization:

```typescript
const aiStats = loggerService.getAITokenStats();
console.log(`Total cost: $${aiStats.totalCost.toFixed(2)}`);
console.log(`Cache savings: $${aiStats.totalCacheSavings.toFixed(2)}`);
```

### Validation Failures

Review common validation errors to identify patterns:

```typescript
const validationStats = loggerService.getValidationStats();
console.log(validationStats.commonErrors);
```
